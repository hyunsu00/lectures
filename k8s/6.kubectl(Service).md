> ë¦¬ì†ŒìŠ¤ ì œê±°  
> ì‹¤ìŠµì´ ëë‚˜ë©´ delete ëª…ë ¹ì–´ë¡œ ë¦¬ì†ŒìŠ¤ë¥¼ ì œê±°í•´ì£¼ì„¸ìš”.

# Service

- Podì€ ìì²´ IPë¥¼ ê°€ì§€ê³  ë‹¤ë¥¸ Podê³¼ í†µì‹ í•  ìˆ˜ ìˆì§€ë§Œ, ì‰½ê²Œ ì‚¬ë¼ì§€ê³  ìƒì„±ë˜ëŠ” íŠ¹ì§• ë•Œë¬¸ì— ì§ì ‘ í†µì‹ í•˜ëŠ” ë°©ë²•ì€ ê¶Œì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” Podê³¼ ì§ì ‘ í†µì‹ í•˜ëŠ” ë°©ë²• ëŒ€ì‹ , ë³„ë„ì˜ ê³ ì •ëœ IPë¥¼ ê°€ì§„ ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ê³  ê·¸ ì„œë¹„ìŠ¤ë¥¼ í†µí•´ Podì— ì ‘ê·¼í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

  ![Service](pod-service.1c328260.png)

## Service(ClusterIP) ë§Œë“¤ê¸°

- ClusterIPëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì— ìƒˆë¡œìš´ IPë¥¼ í• ë‹¹í•˜ê³  ì—¬ëŸ¬ ê°œì˜ Podì„ ë°”ë¼ë³´ëŠ” ë¡œë“œë°¸ëŸ°ì„œ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ì„œë¹„ìŠ¤ ì´ë¦„ì„ ë‚´ë¶€ ë„ë©”ì¸ ì„œë²„ì— ë“±ë¡í•˜ì—¬ Pod ê°„ì— ì„œë¹„ìŠ¤ ì´ë¦„ìœ¼ë¡œ í†µì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> êµ¬ë¶„ì  
> í•˜ë‚˜ì˜ YAMLíŒŒì¼ì— ì—¬ëŸ¬ ê°œì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ì •ì˜í•  ë• "---"ë¥¼ êµ¬ë¶„ìë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

redisë¥¼ ì„œë¹„ìŠ¤ë¡œ ë…¸ì¶œ

```yml
# guide/service/counter-redis-svc.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
spec:
  selector:
    matchLabels:
      app: counter
      tier: db
  template:
    metadata:
      labels:
        app: counter
        tier: db
    spec:
      containers:
        - name: redis
          image: redis
          ports:
            - containerPort: 6379
              protocol: TCP

---
apiVersion: v1
kind: Service
metadata:
  name: redis
spec:
  ports:
    - port: 6379
      protocol: TCP
  selector:
    app: counter
    tier: db
```

```bash
# Service / Deployment ìƒì„±
kubectl apply -f counter-redis-svc.yml

# Pod, ReplicaSet, Deployment, Service ìƒíƒœ í™•ì¸
kubectl get all
```

- ê°™ì€ í´ëŸ¬ìŠ¤í„°ì—ì„œ ìƒì„±ëœ Podì´ë¼ë©´ redisë¼ëŠ” ë„ë©”ì¸ìœ¼ë¡œ redis Podì— ì ‘ê·¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (redis.default.svc.cluster.localë¡œë„ ì ‘ê·¼ê°€ëŠ¥ í•©ë‹ˆë‹¤. ì„œë¡œ ë‹¤ë¥¸ namespaceì™€ clusterë¥¼ êµ¬ë¶„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)
  ![Service](clusterip.2e0bd0bf.png)
- | ì •ì˜                  | ì„¤ëª…                                           |
  | --------------------- | ---------------------------------------------- |
  | spec.ports.port       | ì„œë¹„ìŠ¤ê°€ ìƒì„±í•  Port                           |
  | spec.ports.targetPort | ì„œë¹„ìŠ¤ê°€ ì ‘ê·¼í•  Podì˜ Port (ê¸°ë³¸: portë‘ ë™ì¼) |
  | spec.selector         | ì„œë¹„ìŠ¤ê°€ ì ‘ê·¼í•  Podì˜ label ì¡°ê±´               |

redisì— ì ‘ê·¼í•  counter ì•±ì„ Deploymentë¡œ ë§Œë“­ë‹ˆë‹¤.

```yml
# guide/service/counter-app.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: counter
spec:
  selector:
    matchLabels:
      app: counter
      tier: app
  template:
    metadata:
      labels:
        app: counter
        tier: app
    spec:
      containers:
        - name: counter
          image: ghcr.io/subicura/counter:latest
          env:
            - name: REDIS_HOST
              value: "redis"
            - name: REDIS_PORT
              value: "6379"
```

```bash
# Deployment ìƒì„±
kubectl apply -f counter-app.yml

# counter appì— ì ‘ê·¼
kubectl get po
kubectl exec -it counter-<xxxxx> -- sh

apk add curl busybox-extras # install telnet
curl localhost:3000
curl localhost:3000
telnet redis 6379

  dbsize
  KEYS *
  GET count
  quit

exit
```

## Service ìƒì„± íë¦„

![Service](service-ìƒì„±íë¦„.png)

1. Endpoint ControllerëŠ” Serviceì™€ Podì„ ê°ì‹œí•˜ë©´ì„œ ì¡°ê±´ì— ë§ëŠ” Podì˜ IPë¥¼ ìˆ˜ì§‘
2. Endpoint Controllerê°€ ìˆ˜ì§‘í•œ IPë¥¼ ê°€ì§€ê³  Endpoint ìƒì„±
3. Kube-ProxyëŠ” Endpoint ë³€í™”ë¥¼ ê°ì‹œí•˜ê³  ë…¸ë“œì˜ iptablesì„ ì„¤ì •
4. CoreDNSëŠ” Serviceë¥¼ ê°ì‹œí•˜ê³  ì„œë¹„ìŠ¤ ì´ë¦„ê³¼ IPë¥¼ CoreDNSì— ì¶”ê°€

Endpointì˜ ìƒíƒœë¥¼ í™•ì¸

```bash
kubectl get endpoints
kubectl get ep #ì¤„ì—¬ì„œ

# redis Endpoint í™•ì¸
kubectl describe ep/redis
```

## Service(NodePort) ë§Œë“¤ê¸°

- CluterIPëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í´ëŸ¬ìŠ¤í„° ì™¸ë¶€(ë…¸ë“œ)ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ NodePort ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ì–´ë´…ë‹ˆë‹¤.

```yml
# guide/service/counter-nodeport.yml
apiVersion: v1
kind: Service
metadata:
  name: counter-np
spec:
  type: NodePort
  ports:
    - port: 3000
      protocol: TCP
      nodePort: 31000
  selector:
    app: counter
    tier: app
```

| ì •ì˜                | ì„¤ëª…                                                     |
| ------------------- | -------------------------------------------------------- |
| spec.ports.nodePort | ë…¸ë“œì— ì˜¤í”ˆí•  Port (ë¯¸ì§€ì •ì‹œ 30000-32768 ì¤‘ì— ìë™ í• ë‹¹) |

```bash
# Service(NodePort) ìƒì„±
kubectl apply -f counter-nodeport.yml

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
kubectl get svc

# í´ëŸ¬ìŠ¤í„°ì˜ ë…¸ë“œ IP í™•ì¸
minikube ip

curl 192.168.49.2:31000 # ë˜ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ê·¼, IPsëŠ” minikube ip ë¡œ í™•ì¸
```

- NodePortëŠ” í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  ë…¸ë“œì— í¬íŠ¸ë¥¼ ì˜¤í”ˆí•©ë‹ˆë‹¤. ì§€ê¸ˆì€ í…ŒìŠ¤íŠ¸ë¼ì„œ í•˜ë‚˜ì˜ ë…¸ë“œë°–ì— ì—†ì§€ë§Œ ì—¬ëŸ¬ ê°œì˜ ë…¸ë“œê°€ ìˆë‹¤ë©´ ì•„ë¬´ ë…¸ë“œë¡œ ì ‘ê·¼í•´ë„ ì§€ì •í•œ Podìœ¼ë¡œ ì˜ì˜¥ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  ![Service](nodeport.8677d87b.png)
  ![Service](nodeport-multi.8a7b8dce.png)

> NodePortì™€ ClusterIP  
> NodePortëŠ” CluterIPì˜ ê¸°ëŠ¥ì„ ê¸°ë³¸ìœ¼ë¡œ í¬í•¨í•©ë‹ˆë‹¤.

## Service(LoadBalancer) ë§Œë“¤ê¸°

- NodePortì˜ ë‹¨ì ì€ ë…¸ë“œê°€ ì‚¬ë¼ì¡Œì„ ë•Œ ìë™ìœ¼ë¡œ ë‹¤ë¥¸ ë…¸ë“œë¥¼ í†µí•´ ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤ëŠ” ì ì…ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, 3ê°œì˜ ë…¸ë“œê°€ ìˆë‹¤ë©´ 3ê°œ ì¤‘ì— ì•„ë¬´ ë…¸ë“œë¡œ ì ‘ê·¼í•´ë„ NodePortë¡œ ì—°ê²°í•  ìˆ˜ ìˆì§€ë§Œ ì–´ë–¤ ë…¸ë“œê°€ ì‚´ì•„ ìˆëŠ”ì§€ëŠ” ì•Œ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.
  ![Service](lb.1dff4c9d.png)
- ìë™ìœ¼ë¡œ ì‚´ì•„ ìˆëŠ” ë…¸ë“œì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ ëª¨ë“  ë…¸ë“œë¥¼ ë°”ë¼ë³´ëŠ” Load Balancerê°€ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ëŠ” NodePortì— ì§ì ‘ ìš”ì²­ì„ ë³´ë‚´ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ Load Balancerì— ìš”ì²­í•˜ê³  Load Balancerê°€ ì•Œì•„ì„œ ì‚´ì•„ ìˆëŠ” ë…¸ë“œì— ì ‘ê·¼í•˜ë©´ NodePortì˜ ë‹¨ì ì„ ì—†ì•¨ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```yml
# guide/service/counter-lb.yml
piVersion: v1
kind: Service
metadata:
  name: counter-lb
spec:
  type: LoadBalancer
  ports:
    - port: 30000
      targetPort: 3000
      protocol: TCP
  selector:
    app: counter
    tier: app
```

```bash
# Service(LoadBalancer) ìƒì„±
kubectl apply -f counter-lb.yml

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
kubectl get svc
```

## minikubeì— ê°€ìƒ LoadBalancer ë§Œë“¤ê¸°

- Load Balancerë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” í™˜ê²½ì—ì„œ ê°€ìƒ í™˜ê²½ì„ ë§Œë“¤ì–´ ì£¼ëŠ” ê²ƒì´ MetalLBë¼ëŠ” ê²ƒì…ë‹ˆë‹¤. minikubeì—ì„œëŠ” í˜„ì¬ ë–  ìˆëŠ” ë…¸ë“œë¥¼ Load Balancerë¡œ ì„¤ì •í•©ë‹ˆë‹¤. minikubeì˜ addons ëª…ë ¹ì–´ë¡œ í™œì„±í™”í•©ë‹ˆë‹¤.

```bash
# metallbì„¤ì¹˜ - Load Balancerë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” í™˜ê²½ì—ì„œ ê°€ìƒ í™˜ê²½ì„ ë§Œë“¤ì–´ ì¤Œ
minikube addons enable metallb

# ip í™•ì¸
minikube ip
```

```yml
# guide/service/metallb-cm.yml
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: metallb-system
  name: config
data:
  config: |
    address-pools:
    - name: default
      protocol: layer2
      addresses:
      - 192.168.49.2/32 # minikube ip
```

```bash
# ConfigMap ìƒì„±
kubectl apply -f metallb-cm.yml

# ë‹¤ì‹œ ì„œë¹„ìŠ¤ í™•ì¸
kubectl get svc

curl 192.168.64.4:30000 # ë˜ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ê·¼

# ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ ì‚­ì œ
# ì²«ë²ˆì§¸ all ì€ ëª¨ë“  ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ all,
# ë‘ë²ˆì§¸ --all ì€ ì´ë¦„ëŒ€ì‹  ëª¨ë“  ë¦¬ì†ŒìŠ¤
#ê·¸ë¼ë‚˜ secret ì€ ì‚­ì œë˜ì§€ ì•ŠëŠ”ë‹¤.
kubectl delete all --all
```

> LoadBalancerì™€ NodePort  
> LoadBalancerëŠ” NodePortì˜ ê¸°ëŠ¥ì„ ê¸°ë³¸ìœ¼ë¡œ í¬í•¨í•©ë‹ˆë‹¤.

## ë§ˆë¬´ë¦¬

- ì„œë¹„ìŠ¤ëŠ” ë¡œìš°ë ˆë²¨low level ìˆ˜ì¤€ì˜ ë„¤íŠ¸ì›Œí¬ë¥¼ ì´í•´í•˜ê³  ì„±ëŠ¥, ë³´ì•ˆ ì´ìŠˆë¥¼ ì‹ ê²½ ì¨ì•¼ í•©ë‹ˆë‹¤. íŒŒê³ ë“¤ë©´ í•œì—†ì´ ë³µì¡í•˜ê³  ì–´ë ¤ìš´ ë¶€ë¶„ìœ¼ë¡œ ì¼ë‹¨ ê·¸ë ‡êµ¬ë‚˜.. í•˜ê³  ë„˜ì–´ê°‘ë‹ˆë‹¤. ğŸ˜­

- ì‹¤ì „ì—ì„  NodePortì™€ LoadBalancerë¥¼ ì œí•œì ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. ë³´í†µ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬í•˜ë©´ 80 ë˜ëŠ” 443 í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ê³  í•˜ë‚˜ì˜ í¬íŠ¸ì—ì„œ ì—¬ëŸ¬ ê°œì˜ ì„œë¹„ìŠ¤ë¥¼ ë„ë©”ì¸ì´ë‚˜ ê²½ë¡œì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì—°ê²°í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì´ ë¶€ë¶„ì€ ë’¤ì— Ingressì—ì„œ ìì„¸íˆ ì•Œì•„ë´…ë‹ˆë‹¤.

## ì°¸ê³ 

[Service v1 core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#service-v1-core)  
[ë„¤íŠ¸ì›Œí¬ í†µì‹  ì‹œê°í™”](https://matthewpalmer.net/kubernetes-app-developer/articles/kubernetes-networking-guide-beginners.html)

## ë¬¸ì œ

### ë¬¸ì œ1

| í‚¤                | ê°’                       |
| ----------------- | ------------------------ |
| Deployment ì´ë¦„   | echo                     |
| Deployment Label  | app: echo                |
| Deployment ë³µì œìˆ˜ | 3                        |
| Container ì´ë¦„    | echo                     |
| Container ì´ë¯¸ì§€  | ghcr.io/subicura/echo:v1 |
| NodePort ì´ë¦„     | echo                     |
| NodePort Port     | 3000                     |
| NodePort NodePort | 32000                    |

```yml
# guide/service/service_exam1.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo
spec:
  replicas: 3
  selector:
    matchLabels:
      app: echo
  template:
    metadata:
      labels:
        app: echo
    spec:
      containers:
        - name: echo
          image: ghcr.io/subicura/echo:v1

---
apiVersion: v1
kind: Service
metadata:
  name: echo
spec:
  type: NodePort
  ports:
    - port: 3000
      protocol: TCP
      nodePort: 32000
  selector:
    app: echo
```
